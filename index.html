<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>WebAR Experience</title>
    <meta name="description" content="Interactive Augmented Reality experience in your browser">
    
    <!-- A-Frame for WebXR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <!-- AR.js for additional AR features (optional enhancement) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- Gesture Detector Component for A-Frame -->
    <script src="https://unpkg.com/aframe-gesture-detector@4.2.2/dist/gesture-detector.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>Loading AR Experience</h2>
            <p>Preparing your augmented reality...</p>
        </div>
    </div>

    <!-- Permission Screen -->
    <div id="permission-screen" class="overlay hidden">
        <div class="permission-content">
            <div class="icon-camera">üì∑</div>
            <h2>Camera Access Required</h2>
            <p>This AR experience needs access to your camera to display 3D content in the real world.</p>
            <button id="grant-permission-btn" class="primary-btn">Enable Camera</button>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="error-screen" class="overlay hidden">
        <div class="error-content">
            <div class="icon-error">‚ö†Ô∏è</div>
            <h2 id="error-title">Something went wrong</h2>
            <p id="error-message">Please try again or use a different device.</p>
            <button id="retry-btn" class="primary-btn">Retry</button>
            <button id="fallback-btn" class="secondary-btn">View 3D Model</button>
        </div>
    </div>

    <!-- Unsupported Browser Screen -->
    <div id="unsupported-screen" class="overlay hidden">
        <div class="unsupported-content">
            <div class="icon-warning">üö´</div>
            <h2>AR Not Supported</h2>
            <p>Your browser doesn't support WebXR. Please use:</p>
            <ul>
                <li><strong>iOS:</strong> Safari 15.4+ on iPhone/iPad</li>
                <li><strong>Android:</strong> Chrome 79+ or Samsung Internet 11.2+</li>
            </ul>
            <button id="view-3d-btn" class="primary-btn">View 3D Model Instead</button>
        </div>
    </div>

    <!-- AR Scene -->
    <a-scene
        id="ar-scene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        gesture-detector
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true;"
        loading-screen="enabled: false"
        device-orientation-permission-ui="enabled: false">
        
        <!-- Camera -->
        <a-entity camera look-controls-enabled="false"></a-entity>
        
        <!-- Lighting -->
        <a-light type="ambient" intensity="0.8"></a-light>
        <a-light type="directional" intensity="0.5" position="1 1 1"></a-light>
        <a-light type="hemisphere" intensity="0.6"></a-light>
        
        <!-- 3D Model Container -->
        <a-entity id="model-container" position="0 0 -3">
            <!-- The 3D model will be loaded here dynamically -->
            <a-gltf-model
                id="ar-model"
                rotation="0 0 0"
                scale="1 1 1"
                position="0 0 0"
                gesture-handler="minScale: 0.25; maxScale: 10"
                shadow="cast: true; receive: false"
                animation-mixer>
            </a-gltf-model>
        </a-entity>

        <!-- Ground plane for shadows (optional) -->
        <a-plane
            id="ground"
            rotation="-90 0 0"
            width="100"
            height="100"
            color="#ffffff"
            shadow="receive: true"
            visible="false">
        </a-plane>
    </a-scene>

    <!-- UI Controls Overlay -->
    <div id="ar-controls" class="controls-overlay hidden">
        <div class="controls-header">
            <h3>üéØ AR Active</h3>
            <button id="exit-ar-btn" class="icon-btn">‚úï</button>
        </div>
        
        <div class="controls-instructions">
            <div class="instruction-item">
                <span class="icon">üëÜ</span>
                <span>Drag to move</span>
            </div>
            <div class="instruction-item">
                <span class="icon">üîÑ</span>
                <span>Two fingers to rotate</span>
            </div>
            <div class="instruction-item">
                <span class="icon">ü§è</span>
                <span>Pinch to scale</span>
            </div>
        </div>

        <div class="controls-actions">
            <button id="reset-btn" class="control-btn">Reset Position</button>
            <button id="screenshot-btn" class="control-btn">üì∏ Capture</button>
        </div>
    </div>

    <!-- Performance Monitor (dev mode) -->
    <div id="performance-monitor" class="hidden">
        <div class="perf-stat">
            <span class="label">FPS:</span>
            <span id="fps-counter">60</span>
        </div>
        <div class="perf-stat">
            <span class="label">Memory:</span>
            <span id="memory-counter">0 MB</span>
        </div>
    </div>

    <!-- Custom JavaScript -->
    <script src="app.js"></script>

    <!-- A-Frame Gesture Handler Component -->
    <script>
        // Register custom gesture handler component for A-Frame
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.3 },
                maxScale: { default: 8 },
            },

            init: function () {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);

                this.isVisible = false;
                this.initialScale = this.el.object3D.scale.clone();
                this.scaleFactor = 1;

                this.el.sceneEl.addEventListener('markerFound', (e) => {
                    this.isVisible = true;
                });

                this.el.sceneEl.addEventListener('markerLost', (e) => {
                    this.isVisible = false;
                });
            },

            play: function () {
                const sceneEl = this.el.sceneEl;
                sceneEl.addEventListener('onefingermove', this.handleRotation);
                sceneEl.addEventListener('twofingermove', this.handleScale);
            },

            pause: function () {
                const sceneEl = this.el.sceneEl;
                sceneEl.removeEventListener('onefingermove', this.handleRotation);
                sceneEl.removeEventListener('twofingermove', this.handleScale);
            },

            handleRotation: function (event) {
                if (this.data.enabled) {
                    this.el.object3D.rotation.y +=
                        event.detail.positionChange.x * this.data.rotationFactor;
                    this.el.object3D.rotation.x +=
                        event.detail.positionChange.y * this.data.rotationFactor;
                }
            },

            handleScale: function (event) {
                if (this.data.enabled) {
                    this.scaleFactor *=
                        1 + event.detail.spreadChange / event.detail.startSpread;

                    this.scaleFactor = Math.min(
                        Math.max(this.scaleFactor, this.data.minScale),
                        this.data.maxScale
                    );

                    this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
                    this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
                    this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
                }
            },
        });
    </script>
</body>
</html>
